<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Maintenance & Services</title>
    <!-- Include SheetJS library for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-weight: bold;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background-color: var(--success-color);
        }
        
        .btn-primary:hover {
            background-color: #27ae60;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:disabled:hover {
            background-color: #bdc3c7;
            box-shadow: none;
            transform: none;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            flex-direction: column;
            gap: 15px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        .success-message {
            background-color: #d1edff;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        .data-source-info {
            background-color: #e7f3ff;
            color: #0c5460;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .data-source-info i {
            font-size: 1.2rem;
        }

        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .filters-list {
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .filters-list table {
            width: 100%;
            box-shadow: none;
            border-radius: 0;
        }

        .filters-list th {
            background-color: #f8f9fa;
            color: var(--dark-color);
        }

        .filters-list th, .filters-list td {
            padding: 10px 15px;
            text-align: left;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            color: #bdc3c7;
        }

        .step.active {
            color: var(--secondary-color);
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .step.active .step-number {
            background-color: var(--secondary-color);
            color: white;
        }

        .step-line {
            width: 30px;
            height: 2px;
            background-color: #ecf0f1;
            margin: 0 10px;
        }

        .step.active ~ .step-line {
            background-color: var(--secondary-color);
        }
        
        .qty-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .qty-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }
        
        .qty-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }
        
        .ideal-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--success-color);
            cursor: pointer;
        }
        
        .status-indicator.not-ideal {
            background-color: var(--accent-color);
        }
        
        .additional-items {
            margin-top: 20px;
        }
        
        .additional-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .additional-item input {
            flex: 1;
        }
        
        .add-item-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .preview-table th, .preview-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .preview-table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .step-line {
                width: 20px;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .step-indicator {
                font-size: 0.9rem;
            }
            
            .step-number {
                width: 25px;
                height: 25px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i>🚛</i> FLEET MAINTENANCE & SERVICES
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="data-source-info">
            <i>📊</i>
            <span>Data Source: GitHub Repository - Fleet PMS.xlsx</span>
        </div>
        
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Loading fleet data from GitHub repository...</p>
        </div>
        
        <div id="errorContainer" style="display: none;"></div>
        <div id="successContainer" style="display: none;"></div>
        
        <!-- Debug information (can be removed in production) -->
        <div id="debugContainer" style="display: none;">
            <h3>Debug Information:</h3>
            <div class="debug-info" id="debugInfo"></div>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="action-buttons">
                <button class="btn btn-primary" id="newServiceBtn">
                    <i>➕</i> New Service
                </button>
                <button class="btn" id="serviceHistoryBtn">
                    <i>📋</i> Service History
                </button>
                <button class="btn" id="refreshDataBtn">
                    <i>🔄</i> Refresh Data
                </button>
                <button class="btn" id="debugToggleBtn">
                    <i>🐛</i> Debug Info
                </button>
            </div>
        </div>
    </div>

    <!-- New Service Modal -->
    <div class="modal" id="newServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">New Service</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-text">Select Fleet</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-text">Service Type</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-text">Service Cabin</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-text">Filters</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step5">
                        <div class="step-number">5</div>
                        <div class="step-text">Additional Items</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step6">
                        <div class="step-number">6</div>
                        <div class="step-text">Assignee</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step7">
                        <div class="step-number">7</div>
                        <div class="step-text">Preview</div>
                    </div>
                </div>

                <form id="newServiceForm">
                    <!-- Step 1: Select Fleet -->
                    <div class="form-step active" id="step1-form">
                        <div class="form-group">
                            <label for="fleetSelect">Select Fleet</label>
                            <select id="fleetSelect" required>
                                <option value="">-- Select a fleet --</option>
                                <!-- Fleet options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="nextToStep2">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: Service Type -->
                    <div class="form-step" id="step2-form">
                        <div class="form-group">
                            <label for="serviceTypeSelect">Service Type</label>
                            <select id="serviceTypeSelect" required>
                                <option value="">-- Select service type --</option>
                                <option value="A">Service A</option>
                                <option value="B">Service B</option>
                                <option value="C">Service C</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="backToStep1">Back</button>
                            <button type="button" class="btn btn-primary" id="nextToStep3">Next</button>
                        </div>
                    </div>

                    <!-- Step 3: Service Cabin -->
                    <div class="form-step" id="step3-form">
                        <div class="form-group">
                            <label for="serviceCabin">Service Cabin</label>
                            <select id="serviceCabin" required>
                                <option value="">-- Select service cabin --</option>
                                <option value="S/S">S/S</option>
                                <option value="D/C">D/C</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="backToStep2">Back</button>
                            <button type="button" class="btn btn-primary" id="nextToStep4">Next</button>
                        </div>
                    </div>

                    <!-- Step 4: Filters -->
                    <div class="form-step" id="step4-form">
                        <p>Assigned filters for the selected fleet and service type:</p>
                        <div class="filters-list">
                            <table id="filtersTable">
                                <thead>
                                    <tr>
                                        <th>Filter Name</th>
                                        <th>Ideal Status</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                    </tr>
                                </thead>
                                <tbody id="filtersTableBody">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-group">
                            <label>Lubricants</label>
                            <div class="filters-list">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Lubricant Type</th>
                                            <th>Ideal Status</th>
                                            <th>Quantity (Ltrs)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Engine Oil</td>
                                            <td class="ideal-status">
                                                <div class="status-indicator ideal" id="engineOilStatus"></div>
                                                <span>Ideal</span>
                                            </td>
                                            <td>
                                                <div class="qty-control">
                                                    <button type="button" class="qty-btn" id="engineOilDecrease">-</button>
                                                    <span class="qty-value" id="engineOilQty">5</span>
                                                    <button type="button" class="qty-btn" id="engineOilIncrease">+</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Gear Oil</td>
                                            <td class="ideal-status">
                                                <div class="status-indicator ideal" id="gearOilStatus"></div>
                                                <span>Ideal</span>
                                            </td>
                                            <td>
                                                <div class="qty-control">
                                                    <button type="button" class="qty-btn" id="gearOilDecrease">-</button>
                                                    <span class="qty-value" id="gearOilQty">2</span>
                                                    <button type="button" class="qty-btn" id="gearOilIncrease">+</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="backToStep3">Back</button>
                            <button type="button" class="btn btn-primary" id="nextToStep5">Next</button>
                        </div>
                    </div>

                    <!-- Step 5: Additional Items -->
                    <div class="form-step" id="step5-form">
                        <div class="form-group">
                            <label>Additional Items (if any)</label>
                            <div class="additional-items" id="additionalItems">
                                <div class="additional-item">
                                    <input type="text" placeholder="Item name">
                                    <input type="number" placeholder="Qty" min="1">
                                    <select>
                                        <option value="pieces">Pieces</option>
                                        <option value="ltrs">Liters</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="add-item-btn" id="addItemBtn">
                                <i>➕</i> Add Another Item
                            </button>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="backToStep4">Back</button>
                            <button type="button" class="btn btn-primary" id="nextToStep6">Next</button>
                        </div>
                    </div>

                    <!-- Step 6: Assignee -->
                    <div class="form-step" id="step6-form">
                        <div class="form-group">
                            <label for="assigneeName">Assignee Name</label>
                            <input type="text" id="assigneeName" placeholder="Enter assignee name" required>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="backToStep5">Back</button>
                            <button type="button" class="btn btn-primary" id="nextToStep7">Next</button>
                        </div>
                    </div>

                    <!-- Step 7: Preview -->
                    <div class="form-step" id="step7-form">
                        <h3>Service Preview</h3>
                        <p>Please review the service details before submitting:</p>
                        
                        <div class="preview-table-container">
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Details</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="backToStep6">Back</button>
                            <button type="submit" class="btn btn-primary">Submit Service</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let fleetData = [];
        let isDataLoaded = false;

        // DOM elements
        const newServiceBtn = document.getElementById('newServiceBtn');
        const serviceHistoryBtn = document.getElementById('serviceHistoryBtn');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const debugToggleBtn = document.getElementById('debugToggleBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorContainer = document.getElementById('errorContainer');
        const successContainer = document.getElementById('successContainer');
        const debugContainer = document.getElementById('debugContainer');
        const debugInfo = document.getElementById('debugInfo');
        const mainContent = document.getElementById('mainContent');
        const newServiceModal = document.getElementById('newServiceModal');
        const closeModalBtn = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const newServiceForm = document.getElementById('newServiceForm');

        // Form navigation buttons
        const nextToStep2Btn = document.getElementById('nextToStep2');
        const backToStep1Btn = document.getElementById('backToStep1');
        const nextToStep3Btn = document.getElementById('nextToStep3');
        const backToStep2Btn = document.getElementById('backToStep2');
        const nextToStep4Btn = document.getElementById('nextToStep4');
        const backToStep3Btn = document.getElementById('backToStep3');
        const nextToStep5Btn = document.getElementById('nextToStep5');
        const backToStep4Btn = document.getElementById('backToStep4');
        const nextToStep6Btn = document.getElementById('nextToStep6');
        const backToStep5Btn = document.getElementById('backToStep5');
        const nextToStep7Btn = document.getElementById('nextToStep7');
        const backToStep6Btn = document.getElementById('backToStep6');

        // Step indicators
        const step1Indicator = document.getElementById('step1');
        const step2Indicator = document.getElementById('step2');
        const step3Indicator = document.getElementById('step3');
        const step4Indicator = document.getElementById('step4');
        const step5Indicator = document.getElementById('step5');
        const step6Indicator = document.getElementById('step6');
        const step7Indicator = document.getElementById('step7');

        // Form steps
        const step1Form = document.getElementById('step1-form');
        const step2Form = document.getElementById('step2-form');
        const step3Form = document.getElementById('step3-form');
        const step4Form = document.getElementById('step4-form');
        const step5Form = document.getElementById('step5-form');
        const step6Form = document.getElementById('step6-form');
        const step7Form = document.getElementById('step7-form');

        // Quantity controls
        const engineOilIncrease = document.getElementById('engineOilIncrease');
        const engineOilDecrease = document.getElementById('engineOilDecrease');
        const engineOilQty = document.getElementById('engineOilQty');
        const gearOilIncrease = document.getElementById('gearOilIncrease');
        const gearOilDecrease = document.getElementById('gearOilDecrease');
        const gearOilQty = document.getElementById('gearOilQty');
        
        // Status indicators
        const engineOilStatus = document.getElementById('engineOilStatus');
        const gearOilStatus = document.getElementById('gearOilStatus');
        
        // Additional items
        const additionalItems = document.getElementById('additionalItems');
        const addItemBtn = document.getElementById('addItemBtn');
        
        // Preview table
        const previewTableBody = document.getElementById('previewTableBody');
        
        // Form selects
        const fleetSelect = document.getElementById('fleetSelect');
        const serviceTypeSelect = document.getElementById('serviceTypeSelect');
        const serviceCabin = document.getElementById('serviceCabin');
        const assigneeName = document.getElementById('assigneeName');

        // Excel file URL - Using CORS proxy to bypass GitHub restrictions
        const EXCEL_FILE_URL = 'https://corsproxy.io/?https://raw.githubusercontent.com/shakeelsnu/PMS/main/Fleet%20PMS.xlsx';

        // Alternative URLs if the first one doesn't work
        const ALTERNATIVE_URLS = [
            'https://api.allorigins.win/raw?url=https://raw.githubusercontent.com/shakeelsnu/PMS/main/Fleet%20PMS.xlsx',
            'https://raw.githubusercontent.com/shakeelsnu/PMS/main/Fleet%20PMS.xlsx'
        ];

        // Initialize the application
        function init() {
            setupEventListeners();
            loadDataFromGitHub();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Button controls
            refreshDataBtn.addEventListener('click', loadDataFromGitHub);
            debugToggleBtn.addEventListener('click', toggleDebugInfo);
            
            // Modal controls
            newServiceBtn.addEventListener('click', openNewServiceModal);
            closeModalBtn.addEventListener('click', closeNewServiceModal);
            cancelBtn.addEventListener('click', closeNewServiceModal);
            
            // Form navigation
            nextToStep2Btn.addEventListener('click', goToStep2);
            backToStep1Btn.addEventListener('click', goToStep1);
            nextToStep3Btn.addEventListener('click', goToStep3);
            backToStep2Btn.addEventListener('click', goToStep2);
            nextToStep4Btn.addEventListener('click', goToStep4);
            backToStep3Btn.addEventListener('click', goToStep3);
            nextToStep5Btn.addEventListener('click', goToStep5);
            backToStep4Btn.addEventListener('click', goToStep4);
            nextToStep6Btn.addEventListener('click', goToStep6);
            backToStep5Btn.addEventListener('click', goToStep5);
            nextToStep7Btn.addEventListener('click', goToStep7);
            backToStep6Btn.addEventListener('click', goToStep6);
            
            // Quantity controls
            engineOilIncrease.addEventListener('click', () => adjustQuantity(engineOilQty, 1));
            engineOilDecrease.addEventListener('click', () => adjustQuantity(engineOilQty, -1));
            gearOilIncrease.addEventListener('click', () => adjustQuantity(gearOilQty, 1));
            gearOilDecrease.addEventListener('click', () => adjustQuantity(gearOilQty, -1));
            
            // Status toggles
            engineOilStatus.addEventListener('click', () => toggleStatus(engineOilStatus));
            gearOilStatus.addEventListener('click', () => toggleStatus(gearOilStatus));
            
            // Additional items
            addItemBtn.addEventListener('click', addAdditionalItem);
            
            // Form submission
            newServiceForm.addEventListener('submit', submitNewService);
            
            // Service History button
            serviceHistoryBtn.addEventListener('click', showServiceHistory);
        }

        // Load data from GitHub Excel file
        async function loadDataFromGitHub() {
            showLoading();
            hideError();
            hideSuccess();
            
            let success = false;
            let lastError = '';

            // Try multiple URLs in case of CORS issues
            for (const url of [EXCEL_FILE_URL, ...ALTERNATIVE_URLS]) {
                try {
                    console.log('Trying to fetch from:', url);
                    addDebugInfo(`Trying URL: ${url}`);
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const arrayBuffer = await response.arrayBuffer();
                    
                    // Parse Excel file
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    
                    // Get the first worksheet
                    const worksheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[worksheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    addDebugInfo(`Successfully loaded data from: ${url}`);
                    addDebugInfo(`Excel data structure: ${JSON.stringify(jsonData.slice(0, 3))}`);
                    
                    // Process the data
                    processExcelData(jsonData);
                    
                    success = true;
                    break;
                    
                } catch (error) {
                    console.error(`Failed to fetch from ${url}:`, error);
                    lastError = error.message;
                    addDebugInfo(`Failed to fetch from ${url}: ${error.message}`);
                }
            }
            
            if (success) {
                hideLoading();
                showMainContent();
                showSuccess('Data loaded successfully from GitHub!');
            } else {
                console.error('All URL attempts failed:', lastError);
                showError(`Failed to load data from all sources. Last error: ${lastError}. Using fallback data.`);
                loadFallbackData();
            }
        }

        // Process Excel data into our format
        function processExcelData(excelData) {
            if (!excelData || excelData.length < 2) {
                throw new Error('Excel file is empty or has no data');
            }
            
            const headers = excelData[0];
            fleetData = [];
            
            addDebugInfo(`Headers found: ${headers.join(', ')}`);
            addDebugInfo(`Total rows: ${excelData.length}`);
            
            // Try to auto-detect column indices
            const headerMap = {
                'Fleet Type': 'fleetType',
                'Vehicle Code': 'vehicleCode', 
                'Service Type': 'serviceType',
                'Filter Name': 'filterName',
                'SAP Code': 'sapCode',
                'Qty': 'qty',
                'Quantity': 'qty',
                'Location': 'location'
            };
            
            // Find column indices
            const columnIndices = {};
            headers.forEach((header, index) => {
                const normalizedHeader = String(header).trim();
                if (headerMap[normalizedHeader]) {
                    columnIndices[headerMap[normalizedHeader]] = index;
                    addDebugInfo(`Mapped "${normalizedHeader}" to column ${index}`);
                }
            });
            
            addDebugInfo(`Column indices: ${JSON.stringify(columnIndices)}`);
            
            // Process data rows
            let processedCount = 0;
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                if (row && row.length > 0) {
                    const item = {
                        fleetType: columnIndices.fleetType !== undefined ? String(row[columnIndices.fleetType] || '') : '',
                        vehicleCode: columnIndices.vehicleCode !== undefined ? String(row[columnIndices.vehicleCode] || '') : '',
                        serviceType: columnIndices.serviceType !== undefined ? String(row[columnIndices.serviceType] || '') : '',
                        filterName: columnIndices.filterName !== undefined ? String(row[columnIndices.filterName] || '') : '',
                        sapCode: columnIndices.sapCode !== undefined ? String(row[columnIndices.sapCode] || '') : '',
                        qty: columnIndices.qty !== undefined ? String(row[columnIndices.qty] || '') : '',
                        location: columnIndices.location !== undefined ? String(row[columnIndices.location] || '') : ''
                    };
                    
                    // Only add if we have at least vehicleCode
                    if (item.vehicleCode && item.vehicleCode.trim() !== '') {
                        fleetData.push(item);
                        processedCount++;
                    }
                }
            }
            
            addDebugInfo(`Processed ${processedCount} valid records out of ${excelData.length - 1} total rows`);
            addDebugInfo(`Sample records: ${JSON.stringify(fleetData.slice(0, 3))}`);
            
            // Initialize the application with the loaded data
            initializeWithData();
        }

        // Load fallback data if GitHub fetch fails
        function loadFallbackData() {
            addDebugInfo('Loading fallback data');
            
            // Use comprehensive sample data as fallback
            fleetData = [
                { fleetType: "HINO-CANTER", vehicleCode: "T-7179_QAIG-PT-065_REG #255436", serviceType: "A", filterName: "OIL FILTER", sapCode: "10075229", qty: "1", location: "BH0104C2_S-03" },
                { fleetType: "HINO-CANTER", vehicleCode: "T-7179_QAIG-PT-065_REG #255436", serviceType: "B", filterName: "FUEL FILTER", sapCode: "10075226", qty: "1", location: "BH0104C2_S-03" },
                { fleetType: "HINO-CANTER", vehicleCode: "T-7179_QAIG-PT-065_REG #255436", serviceType: "B", filterName: "FUEL WATER SEP", sapCode: "10075228", qty: "1", location: "BH0104C2_S-03" },
                { fleetType: "HINO-CANTER", vehicleCode: "T-7179_QAIG-PT-065_REG #255436", serviceType: "C", filterName: "AIR FILTER", sapCode: "10023314", qty: "1", location: "BH0104C2_S-04" },
                { fleetType: "HINO-TRUCK", vehicleCode: "T-8868_QAIG-TH-030_REG#68472", serviceType: "A", filterName: "OIL FILTER", sapCode: "10022738", qty: "1", location: "BH0104C2_P-03" },
                { fleetType: "HINO-TRUCK", vehicleCode: "T-8868_QAIG-TH-030_REG#68472", serviceType: "A", filterName: "OIL FILTER", sapCode: "10022739", qty: "1", location: "BH0104C1_P-03, BH0104C2_P-03" },
                { fleetType: "HINO-TRUCK", vehicleCode: "T-8870_QAIG-TH-031_REG#68448", serviceType: "A", filterName: "OIL FILTER", sapCode: "10022738", qty: "1", location: "BH0104C2_P-03" },
                { fleetType: "HINO-TRUCK", vehicleCode: "T-8959_QAIG-TH-048_REG#208968", serviceType: "A", filterName: "OIL FILTER", sapCode: "10022738", qty: "1", location: "BH0104C2_P-03" }
            ];
            
            hideLoading();
            showMainContent();
            initializeWithData();
            showSuccess('Using fallback data. GitHub data could not be loaded.');
        }

        // Initialize the application with loaded data
        function initializeWithData() {
            populateFleetSelect();
            isDataLoaded = true;
            
            addDebugInfo(`Total fleet records: ${fleetData.length}`);
            addDebugInfo(`Unique vehicles: ${[...new Set(fleetData.map(item => item.vehicleCode))].length}`);
        }

        // UI state management functions
        function showLoading() {
            loadingIndicator.style.display = 'flex';
            mainContent.style.display = 'none';
            newServiceBtn.disabled = true;
            serviceHistoryBtn.disabled = true;
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        function showMainContent() {
            mainContent.style.display = 'block';
            newServiceBtn.disabled = false;
            serviceHistoryBtn.disabled = false;
        }

        function showError(message) {
            errorContainer.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
            errorContainer.style.display = 'block';
        }

        function hideError() {
            errorContainer.style.display = 'none';
        }

        function showSuccess(message) {
            successContainer.innerHTML = `
                <div class="success-message">
                    <strong>Success:</strong> ${message}
                </div>
            `;
            successContainer.style.display = 'block';
        }

        function hideSuccess() {
            successContainer.style.display = 'none';
        }

        function addDebugInfo(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        function toggleDebugInfo() {
            if (debugContainer.style.display === 'none') {
                debugContainer.style.display = 'block';
            } else {
                debugContainer.style.display = 'none';
            }
        }

        // Populate fleet select in modal
        function populateFleetSelect() {
            const uniqueVehicles = [...new Set(fleetData.map(item => item.vehicleCode).filter(code => code && code.trim() !== ''))];
            
            addDebugInfo(`Populating fleet select with ${uniqueVehicles.length} unique vehicles`);
            
            // Clear existing options
            fleetSelect.innerHTML = '<option value="">-- Select a fleet --</option>';
            
            if (uniqueVehicles.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No fleets found in data';
                fleetSelect.appendChild(option);
                addDebugInfo('No vehicles found to populate in dropdown');
                return;
            }
            
            uniqueVehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle;
                option.textContent = vehicle;
                fleetSelect.appendChild(option);
            });
            
            addDebugInfo(`Successfully populated ${uniqueVehicles.length} fleets in dropdown`);
        }

        // Rest of the functions remain the same as previous implementation...
        // (Modal functions, form navigation, quantity controls, etc.)

        // Modal functions
        function openNewServiceModal() {
            if (!isDataLoaded) {
                alert('Please wait for data to load');
                return;
            }
            newServiceModal.style.display = 'flex';
            resetForm();
        }

        function closeNewServiceModal() {
            newServiceModal.style.display = 'none';
        }

        function resetForm() {
            goToStep1();
            fleetSelect.value = '';
            serviceTypeSelect.value = '';
            serviceCabin.value = '';
            assigneeName.value = '';
            
            // Reset quantities
            engineOilQty.textContent = '5';
            gearOilQty.textContent = '2';
            
            // Reset status indicators
            engineOilStatus.className = 'status-indicator ideal';
            engineOilStatus.nextElementSibling.textContent = 'Ideal';
            gearOilStatus.className = 'status-indicator ideal';
            gearOilStatus.nextElementSibling.textContent = 'Ideal';
            
            // Reset additional items
            additionalItems.innerHTML = `
                <div class="additional-item">
                    <input type="text" placeholder="Item name">
                    <input type="number" placeholder="Qty" min="1">
                    <select>
                        <option value="pieces">Pieces</option>
                        <option value="ltrs">Liters</option>
                    </select>
                </div>
            `;
            
            // Reset preview table
            previewTableBody.innerHTML = '';
            
            // Populate filters table based on selected fleet and service type
            populateFiltersTable();
        }

        // Form navigation functions
        function goToStep1() {
            setActiveStep(step1Form, step1Indicator);
        }

        function goToStep2() {
            if (!fleetSelect.value) {
                alert('Please select a fleet');
                return;
            }
            setActiveStep(step2Form, step2Indicator);
        }

        function goToStep3() {
            if (!serviceTypeSelect.value) {
                alert('Please select a service type');
                return;
            }
            setActiveStep(step3Form, step3Indicator);
        }

        function goToStep4() {
            if (!serviceCabin.value) {
                alert('Please select a service cabin');
                return;
            }
            populateFiltersTable();
            setActiveStep(step4Form, step4Indicator);
        }

        function goToStep5() {
            setActiveStep(step5Form, step5Indicator);
        }

        function goToStep6() {
            setActiveStep(step6Form, step6Indicator);
        }

        function goToStep7() {
            if (!assigneeName.value) {
                alert('Please enter assignee name');
                return;
            }
            generatePreview();
            setActiveStep(step7Form, step7Indicator);
        }

        // Set active step
        function setActiveStep(stepForm, stepIndicator) {
            // Hide all steps
            step1Form.classList.remove('active');
            step2Form.classList.remove('active');
            step3Form.classList.remove('active');
            step4Form.classList.remove('active');
            step5Form.classList.remove('active');
            step6Form.classList.remove('active');
            step7Form.classList.remove('active');
            
            // Remove active from all indicators
            step1Indicator.classList.remove('active');
            step2Indicator.classList.remove('active');
            step3Indicator.classList.remove('active');
            step4Indicator.classList.remove('active');
            step5Indicator.classList.remove('active');
            step6Indicator.classList.remove('active');
            step7Indicator.classList.remove('active');
            
            // Show active step
            stepForm.classList.add('active');
            stepIndicator.classList.add('active');
        }

        // Populate filters table with data from Excel
        function populateFiltersTable() {
            const filtersTableBody = document.getElementById('filtersTableBody');
            const selectedFleet = fleetSelect.value;
            const selectedServiceType = serviceTypeSelect.value;
            
            addDebugInfo(`Populating filters for fleet: ${selectedFleet}, service type: ${selectedServiceType}`);
            
            // Filter data based on selection
            const filteredData = fleetData.filter(item => {
                return item.vehicleCode === selectedFleet && item.serviceType === selectedServiceType;
            });
            
            addDebugInfo(`Found ${filteredData.length} matching records`);
            
            filtersTableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center;">No filters found for this combination</td>`;
                filtersTableBody.appendChild(row);
            } else {
                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    // Random ideal status for demonstration
                    const isIdeal = Math.random() > 0.3;
                    
                    row.innerHTML = `
                        <td>${item.filterName}</td>
                        <td class="ideal-status">
                            <div class="status-indicator ${isIdeal ? 'ideal' : 'not-ideal'}"></div>
                            <span>${isIdeal ? 'Ideal' : 'Not Ideal'}</span>
                        </td>
                        <td>
                            <div class="qty-control">
                                <button type="button" class="qty-btn">-</button>
                                <span class="qty-value">${item.qty}</span>
                                <button type="button" class="qty-btn">+</button>
                            </div>
                        </td>
                        <td>Pieces</td>
                    `;
                    filtersTableBody.appendChild(row);
                    
                    // Add event listeners to the quantity buttons
                    const qtyButtons = row.querySelectorAll('.qty-btn');
                    const qtyValue = row.querySelector('.qty-value');
                    
                    qtyButtons[0].addEventListener('click', () => adjustQuantity(qtyValue, -1));
                    qtyButtons[1].addEventListener('click', () => adjustQuantity(qtyValue, 1));
                    
                    // Add event listener to the status indicator
                    const statusIndicator = row.querySelector('.status-indicator');
                    const statusText = row.querySelector('.ideal-status span');
                    statusIndicator.addEventListener('click', function() {
                        toggleStatus(this, statusText);
                    });
                });
            }
        }

        // Adjust quantity
        function adjustQuantity(qtyElement, change) {
            let currentQty = parseInt(qtyElement.textContent);
            currentQty += change;
            
            if (currentQty < 0) currentQty = 0;
            
            qtyElement.textContent = currentQty;
        }

        // Toggle status between ideal and not ideal
        function toggleStatus(statusElement, statusTextElement = null) {
            if (statusElement.classList.contains('ideal')) {
                statusElement.classList.remove('ideal');
                statusElement.classList.add('not-ideal');
                if (statusTextElement) statusTextElement.textContent = 'Not Ideal';
            } else {
                statusElement.classList.remove('not-ideal');
                statusElement.classList.add('ideal');
                if (statusTextElement) statusTextElement.textContent = 'Ideal';
            }
        }

        // Add additional item
        function addAdditionalItem() {
            const newItem = document.createElement('div');
            newItem.className = 'additional-item';
            newItem.innerHTML = `
                <input type="text" placeholder="Item name">
                <input type="number" placeholder="Qty" min="1">
                <select>
                    <option value="pieces">Pieces</option>
                    <option value="ltrs">Liters</option>
                </select>
            `;
            additionalItems.appendChild(newItem);
        }

        // Generate preview
        function generatePreview() {
            previewTableBody.innerHTML = '';
            
            // Add service details
            addPreviewRow('Fleet', fleetSelect.options[fleetSelect.selectedIndex].text);
            addPreviewRow('Service Type', serviceTypeSelect.options[serviceTypeSelect.selectedIndex].text);
            addPreviewRow('Service Cabin', serviceCabin.options[serviceCabin.selectedIndex].text);
            addPreviewRow('Assignee', assigneeName.value);
            
            // Add filters
            const filterRows = document.querySelectorAll('#filtersTableBody tr');
            filterRows.forEach(row => {
                const cells = row.cells;
                const name = cells[0].textContent;
                const status = cells[1].querySelector('span').textContent;
                const qty = cells[2].querySelector('.qty-value').textContent;
                const unit = cells[3].textContent;
                
                addPreviewRow(name, `${qty} ${unit}`, status);
            });
            
            // Add lubricants
            addPreviewRow('Engine Oil', `${engineOilQty.textContent} Ltrs`, 
                         engineOilStatus.classList.contains('ideal') ? 'Ideal' : 'Not Ideal');
            addPreviewRow('Gear Oil', `${gearOilQty.textContent} Ltrs`, 
                         gearOilStatus.classList.contains('ideal') ? 'Ideal' : 'Not Ideal');
            
            // Add additional items
            const additionalItemInputs = additionalItems.querySelectorAll('.additional-item');
            additionalItemInputs.forEach(item => {
                const inputs = item.querySelectorAll('input, select');
                const name = inputs[0].value;
                const qty = inputs[1].value;
                const unit = inputs[2].value;
                
                if (name && qty) {
                    addPreviewRow(name, `${qty} ${unit === 'pieces' ? 'Pieces' : 'Ltrs'}`);
                }
            });
        }

        // Add row to preview table
        function addPreviewRow(item, details, status = '') {
            const row = document.createElement('tr');
            
            if (status) {
                row.innerHTML = `
                    <td>${item}</td>
                    <td>${details}</td>
                    <td>${status}</td>
                `;
                
                // Color code the status
                const statusCell = row.cells[2];
                if (status === 'Ideal') {
                    statusCell.style.color = 'var(--success-color)';
                    statusCell.style.fontWeight = 'bold';
                } else if (status === 'Not Ideal') {
                    statusCell.style.color = 'var(--accent-color)';
                    statusCell.style.fontWeight = 'bold';
                }
            } else {
                row.innerHTML = `
                    <td>${item}</td>
                    <td colspan="2">${details}</td>
                `;
            }
            
            previewTableBody.appendChild(row);
        }

        // Submit new service form
        function submitNewService(e) {
            e.preventDefault();
            
            // In a real application, you would send this data to a server
            alert('Service submitted successfully!');
            
            // Close modal
            closeNewServiceModal();
        }

        // Show service history (placeholder)
        function showServiceHistory() {
            alert('Service History functionality would show a detailed history of all services.');
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>